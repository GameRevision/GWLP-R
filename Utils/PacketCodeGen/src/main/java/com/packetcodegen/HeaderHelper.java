/**
 * For copyright information see the LICENSE document.
 */

package com.packetcodegen;

import java.text.SimpleDateFormat;
import java.util.Calendar;

/**
 * Manages the header of an Action or a nested struct.
 * 
 * @author miracle444
 */
public final class HeaderHelper 
{
    
    private final String firstPart;     // contains the first part of the header code
    private final String secondPart;    // contains the second part of the header code
    private String imports;             // contains the imports code
    private boolean hasBufferImports;   // indicates whether it already has the buffer imports
    private PacketConverter packet;     // the packet this header corresponds to
    
    /**
     * Constructor.
     * this constructor is used by ClassHelper objects.
     * 
     * @param   packet      the packet this header corresponds to
     */
    public HeaderHelper(PacketConverter packet)
    {
        this.packet = packet;
        
        this.firstPart =
                "/**\n" +
                " * For copyright information see the LICENSE document.\n" +
                " */\n" +
                "\n" +
                "/**\n" +
                " * Auto-generated by PacketCodeGen, on " + getDate() + "\n" +
                " */\n" +
                "\n" +
                "package " + packet.getPackageName() + ";\n" +
                "\n";
        
        this.imports =
                (packet.getFromClient() ? "import com.realityshard.shardlet.EventAggregator;\n" : "") +
                (packet.getFromClient() ? "import com.realityshard.shardlet.GenericEventAction;" : "import com.realityshard.shardlet.GenericAction;") + "\n" +
                (packet.getFromClient() ? "" : "import java.nio.BufferOverflowException;\n") +
                (packet.getFromClient() ? "" : "import java.nio.ByteBuffer;\n") +
                (packet.getFromClient() ? "" : "import java.nio.ByteOrder;\n");
        
        this.secondPart =                
                "\n" +
                "/**\n" + 
                " * This is an automatically generated ShardletAction.\n" +
                " * It resembles the packet template that has been \n" +
                " * parsed from our packet templates xml.\n" +
                " *\n" +
                packet.getDescription() +
                " *\n" +
                " * @author " + packet.getAuthor() + "\n" +
                " */\n" +
                "public final class " + packet.getActionName() + " extends " +
                    (packet.getFromClient() ? "GenericEventAction" : "GenericAction") + "\n" +
                "{\n" +
                "\n";
    }

    
    /**
     * Constructor.
     * this constructor is used by nested structs. 
     * 
     * @param   indention       the number of spaces of an indentation.
     * @param   field           the nested struct field this header is corresponding to.
     */
    public HeaderHelper(final String indention, FieldConverter field)
    {
        this.firstPart = this.imports = "";
        
        this.secondPart =
                indention + "public final class " + field.getType() + "\n" +
                indention + "{\n" +
                indention + "\n";
    }
    
    
    /**
     * iteration routine to add fields to check for selective imports.
     * 
     * @param       field           the field that has to be added.
     */
    public void addField(final FieldConverter field)
    {
        if (packet.getFromClient())
        {
                addBufferImports();
        }
    }
    
    
    /**
     * Helper function.
     * adds the buffer imports and makes sure they are only added once.
     */
    private void addBufferImports()
    {
        if (!hasBufferImports)
        {
            hasBufferImports = true;
            this.imports += 
                (packet.getFromClient() ? "import java.nio.BufferUnderflowException;\n" : "") +
                "import java.nio.ByteBuffer;\n";
        }
    }
    
    
    /**
     * Getter.
     * 
     * @return  the complete header managed by this class. 
     */
    @Override
    public String toString()
    {
        return this.firstPart + this.imports + this.secondPart;
    }
    

    /**
     * Helper function.
     * 
     * @return  the current date.
     */
    private String getDate()
    {
        return (new SimpleDateFormat("yyyy-MM-dd")).format(Calendar.getInstance().getTime());
    }
}
